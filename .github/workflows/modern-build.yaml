name: ğŸš€ Build OpenWrt for x1_riscv64

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'Enable SSH debugging'
        required: false
        default: false
        type: boolean
      version:
        description: 'OpenWrt branch'
        required: false
        default: 'openwrt-24.10'
        type: string
      force_rebuild:
        description: 'Force clean rebuild'
        required: false
        default: false
        type: boolean
      upload_release:
        description: 'Upload to GitHub Releases'
        required: false
        default: true
        type: boolean
      cleanup_releases:  # Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ
        description: 'Clean old releases after build'
        required: false
        default: false
        type: boolean

env:
  # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
  BUILD_ROOT: ${{ github.workspace }}/openwrt
  TZ: Europe/Moscow
  
  # Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
  NPROC: $(($(nproc) + 1))

jobs:
  prepare:
    name: ğŸ“¦ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    runs-on: ubuntu-22.04
    outputs:
      cache_key: ${{ steps.cache_key.outputs.value }}
    
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: ğŸ” Validate required files
        id: validate
        run: |
          REQUIRED_FILES=("dependencies.txt" "custom-feeds.sh")
          missing_files=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              missing_files+=("$file")
            fi
          done
          
          if [[ ${#missing_files[@]} -gt 0 ]]; then
            echo "âŒ Missing files: ${missing_files[*]}"
            echo "status=error" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          echo "status=success" >> "$GITHUB_OUTPUT"
          
      - name: ğŸ—ï¸ Setup build environment
        if: steps.validate.outputs.status == 'success'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ• Setting timezone to $TZ"
          sudo timedatectl set-timezone "$TZ"
          
          echo "ğŸ“¦ Installing dependencies..."
          sudo apt-get update -qq
          
          # Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
          if [[ -f "dependencies.txt" ]]; then
            sudo xargs apt-get install -qq --no-install-recommends -y < dependencies.txt
          else
            # ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ Ğ´Ğ»Ñ OpenWrt
            sudo apt-get install -qq -y \
              build-essential ccache curl file gawk gettext git \
              libncurses-dev libssl-dev python3 rsync unzip wget \
              zlib1g-dev
          fi
          
          echo "ğŸ§¹ Cleaning up..."
          sudo apt-get autoremove -qq -y
          sudo apt-get clean -qq
          sudo rm -rf /var/lib/apt/lists/*
          
      - name: ğŸ—ï¸ Generate cache key
        id: cache_key
        if: steps.validate.outputs.status == 'success'
        run: |
          # Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸ Ğ²ĞµÑ‚ĞºĞ¸
          DEPS_HASH=$(sha256sum dependencies.txt 2>/dev/null | cut -d' ' -f1 || echo "no-deps")
          KEY="${{ github.sha }}-${{ github.event.inputs.version || 'openwrt-24.10' }}-$DEPS_HASH"
          echo "value=$KEY" >> "$GITHUB_OUTPUT"
          echo "Generated cache key: $KEY"

  build:
    name: ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ÑˆĞ¸Ğ²ĞºĞ¸
    needs: prepare
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      FORCE_UNSAFE_CONFIGURE: 1
      
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download OpenWrt sources
        run: |
          echo "ğŸ“¥ Cloning OpenWrt branch: ${{ github.event.inputs.version || 'openwrt-24.10' }}"
          REPO_URL="https://github.com/neuro-dev/openwrt.git"
          BRANCH="${{ github.event.inputs.version || 'openwrt-24.10' }}"
          
          if [[ "${{ github.event.inputs.force_rebuild || 'false' }}" == "true" ]]; then
            echo "ğŸ§¹ Force clean clone requested"
            rm -rf "$BUILD_ROOT"
          fi
          
          if [[ ! -d "$BUILD_ROOT/.git" ]]; then
            git clone --depth=1 --branch "$BRANCH" "$REPO_URL" "$BUILD_ROOT"
          else
            echo "âœ… Repository already exists, updating..."
            cd "$BUILD_ROOT"
            git fetch origin "$BRANCH"
            git reset --hard origin/"$BRANCH"
          fi
          
      - name: ğŸ—ƒï¸ Restore ccache and downloads cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.BUILD_ROOT }}/dl
            ${{ env.BUILD_ROOT }}/.ccache
            ~/.ccache
          key: ${{ needs.prepare.outputs.cache_key }}
          restore-keys: |
            openwrt-dl-
            
      - name: ğŸ”§ Apply custom configurations
        run: |
          echo "ğŸ”§ Applying custom configurations..."
          chmod +x *.sh 2>/dev/null || true
          
          # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğµ Ñ„Ğ¸Ğ´Ñ‹
          if [[ -f "custom-feeds.sh" ]]; then
            echo "ğŸ“¦ Running custom-feeds.sh"
            ./custom-feeds.sh
          fi
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¸Ğ´Ñ‹
          cd "$BUILD_ROOT"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
          if [[ -f "custom-packages.sh" ]]; then
            echo "ğŸ“¦ Running custom-packages.sh"
            ../custom-packages.sh
          fi
          
          # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          if [[ -f "custom-config.sh" ]]; then
            echo "âš™ï¸ Running custom-config.sh"
            ../custom-config.sh
          fi
          
          # ĞŸÑ€ĞµĞ´ÑĞ±Ğ¾Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹
          if [[ -f "prebuild-misc.sh" ]]; then
            echo "ğŸ”¨ Running prebuild-misc.sh"
            ../prebuild-misc.sh
          fi
          
      - name: ğŸ› Enable SSH debugging (optional)
        if: ${{ github.event.inputs.ssh == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          
      - name: ğŸ”¨ Build firmware
        id: compile
        run: |
          cd "$BUILD_ROOT"
          
          echo "ğŸ—ï¸ Starting build with $NPROC threads..."
          echo "ğŸ“Š Available memory: $(free -h | awk '/^Mem:/ {print $2}')"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
          make defconfig
          
          # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
          make download
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸
          if [[ "${{ github.event.inputs.force_rebuild || 'false' }}" == "true" ]]; then
            echo "ğŸ§¹ Force clean build..."
            make clean
          fi
          
          # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹
          set +e
          make -j$NPROC
          EXIT_CODE=$?
          
          # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑĞ´Ñ€Ğ¾Ğ¼ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âš ï¸ Parallel build failed, trying single-threaded with verbose output..."
            make -j1 V=sc 2>&1 | tail -100
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          if ls bin/targets/*/*/openwrt-* 1> /dev/null 2>&1; then
            echo "âœ… Build successful"
            echo "status=success" >> "$GITHUB_OUTPUT"
            
            # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°
            if grep -q '^CONFIG_TARGET.*DEVICE.*=y' .config; then
              DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | \
                           sed -r 's/.*DEVICE_(.*)=y/\1/' | head -1)
              echo "DEVICE_NAME=$DEVICE_NAME" >> "$GITHUB_ENV"
              echo "device_name=$DEVICE_NAME" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "âŒ No firmware files found"
            echo "status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
      - name: ğŸ’¾ Save build cache
        if: steps.compile.outputs.status == 'success'
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.BUILD_ROOT }}/dl
            ${{ env.BUILD_ROOT }}/.ccache
            ~/.ccache
          key: ${{ needs.prepare.outputs.cache_key }}
          
      - name: ğŸ“Š Check disk usage
        if: always()
        run: |
          echo "ğŸ“Š Final disk usage:"
          df -hT
          echo -e "\nğŸ“ Largest directories in workspace:"
          du -sh ${{ github.workspace }}/* | sort -hr | head -10
          
      - name: ğŸ“¦ Prepare artifacts
        if: steps.compile.outputs.status == 'success'
        id: artifacts
        run: |
          cd "$BUILD_ROOT"
          
          # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°
          find bin/targets -name "packages" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ÑĞ±Ğ¾Ñ€ĞºĞµ
          {
            echo "# Build Information"
            echo "Date: $(date)"
            echo "Repository: $GITHUB_REPOSITORY"
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: $GITHUB_SHA"
            echo "OpenWrt Branch: ${{ github.event.inputs.version || 'openwrt-24.10' }}"
            echo "Device: ${{ steps.compile.outputs.device_name || 'unknown' }}"
            echo "Runner: ${{ runner.os }} (${{ runner.arch }})"
            echo -e "\n# SHA256 Checksums"
            echo '```'
            cat bin/targets/*/*/sha256sums 2>/dev/null || echo "No checksums found"
            echo '```'
          } > BUILD_INFO.md
          
          # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ¿Ñ€Ğ¾ÑˆĞ¸Ğ²ĞºĞ°Ğ¼
          FIRMWARE_PATH=$(find bin/targets -type f -name "*.bin" -o -name "*.img" | head -1 | xargs dirname 2>/dev/null || echo "")
          
          if [[ -n "$FIRMWARE_PATH" ]]; then
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… ÑˆĞ°Ğ³Ğ°Ñ…
            echo "$FIRMWARE_PATH" > firmware_path.txt
            echo "ğŸ“ Firmware path: $FIRMWARE_PATH"
            
            # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
            FILE_COUNT=$(find "$FIRMWARE_PATH" -type f | wc -l)
            echo "ğŸ“Š Found $FILE_COUNT firmware files"
          else
            echo "âš ï¸ No firmware files found!"
          fi
          
      - name: ğŸ“ Read firmware path
        id: firmware_path
        if: steps.compile.outputs.status == 'success'
        run: |
          if [[ -f "$BUILD_ROOT/firmware_path.txt" ]]; then
            FIRMWARE_PATH=$(cat "$BUILD_ROOT/firmware_path.txt")
            echo "path=$FIRMWARE_PATH" >> "$GITHUB_OUTPUT"
            echo "Firmware path from file: $FIRMWARE_PATH"
          else
            echo "path=" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ No firmware path file found"
          fi
          
      - name: ğŸš¢ Upload binaries as artifact
        if: steps.compile.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.run_number }}-${{ steps.compile.outputs.device_name || 'unknown' }}
          path: ${{ env.BUILD_ROOT }}/bin
          retention-days: 7
          compression-level: 0
          
      - name: ğŸš¢ Upload firmware as artifact
        if: steps.compile.outputs.status == 'success' && steps.firmware_path.outputs.path != ''
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.run_number }}-${{ steps.compile.outputs.device_name || 'unknown' }}
          path: ${{ env.BUILD_ROOT }}/${{ steps.firmware_path.outputs.path }}
          retention-days: 7
          
      - name: ğŸ·ï¸ Upload to GitHub Release
        if: steps.compile.outputs.status == 'success' && steps.firmware_path.outputs.path != '' && github.event.inputs.upload_release == 'true'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ github.run_number }}
          name: "Build #${{ github.run_number }} - ${{ steps.compile.outputs.device_name || 'unknown' }}"
          body_path: ${{ env.BUILD_ROOT }}/BUILD_INFO.md
          files: ${{ env.BUILD_ROOT }}/${{ steps.firmware_path.outputs.path }}/*
          draft: true
          prerelease: false
          
  cleanup:
    name: ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
    if: always() && github.ref == 'refs/heads/main'
    needs: [build]
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“‹ Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 7
          keep_minimum_runs: 3
          delete_run_by_conclusion_pattern: "failure"
          
      - name: ğŸ—‘ï¸ Cleanup old releases (optional)
        if: ${{ github.event.inputs.cleanup_releases == 'true' && github.ref == 'refs/heads/main' }}
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 10
          delete_tag_pattern: "build-*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
